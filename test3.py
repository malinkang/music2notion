import binascii
import hashlib
import requests
import json
import base64
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import padding
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
# AES 解密函数
EAPI_KEY = b"e82ckenh8dichen8"
EAPI_CRYPTOR = AES.new(EAPI_KEY, AES.MODE_ECB)

headers = {
    "Accept": "*/*",
    "Content-Type": "application/x-www-form-urlencoded",
    "MG-Product-Name": "music",
    "Nm-GCore-Status": "1",
    "Origin": "orpheus://orpheus",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko)"
                  " Chrome/35.0.1916.157 NeteaseMusicDesktop/2.9.7.199711 Safari/537.36",
    "Accept-Encoding": "gzip,deflate",
    "Accept-Language": "en-us,en;q=0.8",
    "Cookie": "MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/openapi/clientlog;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/eapi/feedback;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/api/clientlog;;__csrf=402b189cca8a8c7003444e707b05ed63; Max-Age=1296010; Expires=Fri, 23 Aug 2024 03:20:39 GMT; Path=/;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/weapi/feedback;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/weapi/clientlog;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/neapi/clientlog;;NMTID=00OGexJCAWr6ixTmkN6tYKMEHYMKWUAAAGRMACSdA; Max-Age=315360000; Expires=Sun, 06 Aug 2034 03:20:29 GMT; Path=/;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/eapi/clientlog;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/weapi/clientlog;;MUSIC_U=0094E0D7B4A854133FC85E47DDE068DBE3B779B29B6280B140ABE7A76839078FB79C056E9865F1DFA4BF1FAC6CDCEF7E06ADDA07ED69DDE3FD5ED0B05018AE8259EF7999E58E9E784CAA88627CD9366123C94446F140420FF504360CF3B93E77884707C0FED95583A1F72F987FAFCE6910209088373EFD195005D1F7947C93D43C1CF6EEB05BD6D0B4175695BBBD2D046DA9B75089DCE31C46043403AEAFE439973D439A2666CBC5D5AF27CE7FF944806B1C192057E7AC73AA2C8923A6B20910C363B2FECB59685CC22588D66B8A2CBAF831299EC7301D03349F8087E1F3D9F8AC45187297774E8C9DAF78294ECBA80EC01AA194A7CF6D9DDE499580286E423849CA68B61ABD89E1391AE7E451B156AC1B2EE2F6CCA36D3108315BE70302A29E094E8AD15E26D164FDDD8159A068938EA3B2844FE5907183E8817B53FE91404213B6E93080C0D524F415ECAEEB650FCF69; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/wapi/feedback;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/api/feedback;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/wapi/feedback;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/api/feedback;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/eapi/feedback;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/wapi/clientlog;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/neapi/clientlog;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/neapi/feedback;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/weapi/feedback;;MUSIC_SNS=; Max-Age=0; Expires=Thu, 08 Aug 2024 03:20:29 GMT; Path=/;__remember_me=true; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/wapi/clientlog;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/eapi/clientlog;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/api/clientlog;;MUSIC_A_T=1399653507000; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/neapi/feedback;;MUSIC_R_T=1399653595590; Max-Age=2147483647; Expires=Tue, 26 Aug 2092 06:34:36 GMT; Path=/openapi/clientlog;"
}
def aes_encrypt(data: str | bytes, key: bytes) -> bytes:
    if isinstance(data, str):
        data = data.encode()
    backend = default_backend()
    cipher = Cipher(algorithms.AES(key), modes.ECB(), backend=backend)  # noqa: S305
    encryptor = cipher.encryptor()
    padder = padding.PKCS7(128).padder()
    padded_data = padder.update(data) + padder.finalize()
    return encryptor.update(padded_data) + encryptor.finalize()

def aes_decrypt(cipher_buffer: bytes, key: bytes) -> bytes:
    backend = default_backend()
    cipher = Cipher(algorithms.AES(key), modes.ECB(), backend=backend)  # noqa: S305
    decryptor = cipher.decryptor()
    unpadder = padding.PKCS7(128).unpadder()
    decrypted_data = decryptor.update(cipher_buffer) + decryptor.finalize()
    return unpadder.update(decrypted_data) + unpadder.finalize()

def eapi_params_encrypt(path: bytes, params: dict) -> str:
    """eapi接口参数加密.

    :param path: url路径
    :param params: 明文参数
    :return str: 请求data.
    """
    params_bytes = json.dumps(params, separators=(',', ':')).encode()
    sign_src = b'nobody' + path + b'use' + params_bytes + b'md5forencrypt'
    sign = hashlib.md5(sign_src).hexdigest()  # noqa: S324
    aes_src = path + b'-36cd479b6b5-' + params_bytes + b'-36cd479b6b5-' + sign.encode()
    encrypted_data = aes_encrypt(aes_src, b'e82ckenh8dichen8')
    return f"params={binascii.hexlify(encrypted_data).upper().decode()}"

def eapi_response_decrypt(cipher_buffer: bytes) -> bytes:
    return aes_decrypt(cipher_buffer, b'e82ckenh8dichen8')

def _eapi_request(path: str, params: dict) -> dict:
    """eapi接口请求

    :param path: 请求的路径
    :param params: 请求参数
    :param method: 请求方法
    :return dict: 请求结果
    """
    # encrypted_params = "BE258DF45226179AE3820A8072BDA5D32CD2FE69D99CCB1F9A7BBA7E37663DDBCFCEBF056E23386752334477985ED9CE985FF9BD8B33332DD99CF2526B5B30AF536DA4457761B46D2B5E1B3F4FDB20909E0BCE07645410D0AA7B675698A4CAE67CAFAB8C9AD343A796AB4C783C324BBC136596EA1F7E41EAE088C5C65BF33AA0060FEB6C992A52CC95416DFCEB3FA669"
    encrypted_params = eapi_params_encrypt(path.replace("eapi", "api").encode(), params)
    print(encrypted_params)
    # headers.update({"Content-Length": str(len(params))})
    url = "https://interface3.music.163.com" + path
    response = requests.post(url, headers=headers, data=encrypted_params, timeout=4)
    response.raise_for_status()
    data = eapi_response_decrypt(response.content)
    return json.loads(data)

if __name__ == "__main__":
    params = {
    "type": "month",
    "header": "{}",
    "e_r": True
} 
    data = _eapi_request("/eapi/content/activity/listen/data/report",params=params)
    with open("data.json","w") as f:
        f.write(json.dumps(data,indent=4,ensure_ascii=False))
# end main
# 请求参数
# url = "https://interface3.music.163.com/eapi/link/scene/show/resource"


# data = {
#     "params": "D8A9E26A8D4E2181974D29715FF58061FA8EF213135CC7CEF87F9585F6C2C5D866906423BFDFB2E8B072884B0AD3819B9DB9C59977C81BC4D71365BFD802B30670A2A09FBB209B7D2D5932AE6933F347D9CE14EE516098C6667F3EEA0137F3E9DE7B6FDD7B7AEF7B95992C7C2E8F91A0A3015D4E17D46E22BB3D6CA46BD857C261189D7F4E62D4E95C0E2529F9E4356F431C30981A4E0E0209C9077EA6BCEFF07D18D7A47A2AFC598DDFDBD26C677B571C56B667DBBC1B32A3BB8DA19F7CCC73F1435CE65F552B983F5B91335573A144B257F18829823B90E0F820E42AE14CCED797AB7A4746E66144E38AA1D8B9AD9A7332D94D18617984D1D63487C0587CAB34A57C0851A221BF7F6627671EB54743510CF205700679DDCA1DD74072D669D2BF688257F08BB2CC65518EC40D9A947A77EF25CC6EE87D808DBC5180DB3DAE5FAD1DB2D1C5AC9730092C08FAD65215740BAE5ABFBB460B0C1D9E20539C891060424C5505FE861B28B666318A7DC51C992DE4D131004552A00D12399BDECE344AB2E7FCC501F3403B582201D6A1A90625884B29392E259733C7E84BA32CEECDA16C79911E811350BDB0BB25CA39EF55F4D4E262B554E70B620FD16B6A822E68ED6A9B63D1DB3F02F918221F183F91656DB1EDE882BC19F4CD0A42014DF433C2D314C4EB7F81B124EC30998C230A9A41A228F3E17A7E803F44FC53FC9FE2FD4F6AC7A6AD1EA4CAA7A4D78A2DF9E3B7F8EC816480358F37B3824D2B8C86DCD00D05E2EF69BAB95F2293202829A3FADE6097B019E9BE1A7A4D5B5F7EC14C3C80D0DC995F49A7777EAC4DD63CB07DA5DE8AA4077A097F4CF80F49579488B4799EBAE7D233A7AD4BBACF4C1ABBC47BBFD5097D32763C82890147CE0BDB4ABCD2ACF4E864ADE9ECFB48B98790A49EE95512AD7C4C4DA53FBFE19C3622C6A5C260BC24EB36E31214EA2B92B03E4D451D919C1A255BD31C967AF27A3C2ADB0F5F54A0E5423CA76495E5B69BCA3E13536016B556BBB6F9F512E131BF903CEDD60B99ECE91754ADC88C7E8DD5DC75A7B5CC67F1EC21C61591A7A4BC506F7051380F48650737F727D876AB3F37210BC3F0664CCCBBD3EC40764DF25774A9F8EFDCD3ADCED02BF7F5C169EFBC9635201D63D7760B7703C4F77087335BC01DB614F03F98585F56FF657958347EB5362FC0E4CDF5C7B76B67CAD6F827D1CC3CC15808A7FEEFF08CEDE092DBF747AB82FE8EDD4AD7F8496ED7A8C5784D524EF87EFC11487C186D834F419AD6AA5738FD2A1A680CC8CBAC33239E7FF5DB7A2B9D7BA1F5172DF92B31D0C991866AFC639F32F7B0CD4CF348BFC4A5DD29053AF11AEDEB608B65080CCFCA4DF8199496750739578BDC380DBC078DDB674298371D011C0EEA58D9101D9656AF89A77988F731EDF6A976780BE6F3E1CE90F64E078E4C6E29B3B4C3FCF4C0BA130D11FFAA37F6C260CBD9E6DDEEB24977AAA426F75ECA490243456E14DBA31FF38A3EB7D05549E1B88D254431982B00AD8638D428AA8C57CE7E5D38583693FCDB7FB24FF2B723B2ACE3FF90DAFE8479FDB2D92137D7EA9215530F621750ADD85CE6528BF336DD76265E67F020AF8601F84E1FEFC2A90A4E49145B4E2F2D2D0F811515D50468807FCF1E8920B3377AECA1451F55DC5B3EFAC2D5696F9458200265681128785A6852790C1887840B35FB42062FA4E52BE7067E8C7E5861069B7291DFF99BC4E5CE3797AA5B22817F37427011BAD41E3620B36A10E3A9FD850D9E668C8E85692C84C40AFCCA8303981A86A2889602FE9A8835CBFADEE215CF05E7110828FB5B75A1698F95BFC30BC02F06EE843E9ADD0C24BA1877EE213A8914F5C25D0F77E4739B9643E3A265A8DDBADD42A999BFD160C96E92600F9935A85A040383308B82ACD7FCA198A7E73ABCD1856AF41C7FA735A390C1A8E79397AE41A463F258BECF97380DC3C988A799E29D88AEEE10F8FCF9FC11E378E49FE07997BD97BC118F4B91B0870A6F8E64967AE6401800A39D1C202C0F34A7722F7843A3FF165D6164D99D91EC9395BA9D8D295F933BBEB011CFB4AD22FBD204D51C1625D900698A0F58FDC261AC73BE9568A54204A20E68E6ECC5231C8BCB244011C1EFB6D368438366B3D7B8BF33811AA3D61BFAA0E80942CECA687F7DF4537FA399C2170A606A5CE38642877BD755E4A9A8636CE0A2ABEF992FD1F5D374C79E3F35451E17A11FAB86CCDC0CFA1D247A6997541D119A392ED4DF72EF09352E8C46965ACD240A4FC6D295BD0348458AE7B876F8E7C12156EF050DC83EB4FBDFF8DED4B82DE9102D08C0D5D33CE134148C80C164F687DD963585A5AC05DFE4A722D3470172F102BE8E0D392897F2F178B2BDE93DDBC9BDBDB3C0CB5A9391327747DF9DC9A508A914442019E3D640F0C99A84CBC67B38BF359942A885F2E07C12D16F34CA3A00F57BB5625D50C91D85AA77C3BA0969D2AAD968A5FF2DE4FF8D01DF6F7B0D1EE16F5BE6E3FB9B5AF7BEC5DDD3BD291D5EE1F8ED2684EF41D86EC5E4FE01C309844E13CB9755CBF88EC4FC84F4B1A9327B63A2D3F55C05BAD66C525E8EE63561040CAA5BBB3F3514090A6A5F90C9B11219A00C81CD7E55FBF05C32F2FE2F1B8A5C73647033F3013E1F846B61DDFB2211649E56C70B26494847793B4FC902B191B89B0AFCC3113F127784AFADC8C148A810853BB6A58AC221C7FBECA561A5DE21C89A055A50272236B1AC6089C9FFD7C33862283AA451F3265381B743EFBFD488E0AA10C860723D893B9C8D01522D729BCB5526390698700088AE57EFE526C6BA5C966EEA376A4E5A6346625F7626021CE68FD9C6C4A7023119994D1A017E9EECAAE99BFFB27D0C12A563546CE0707DE99220928AE1C9F14F8916C3CFE3077B46B11C9FFDB681B5D13E696C1EA46958BF7A07AE72BD873982485D7CA0E92CA6FED24593BBFE9B1590370A979C4F4015D1273BA5C4C0EE0A76E59F167A5340524F4DB72B3A408D6D3BD6F365D4A808C15B6D84097C8A5DF00A7791F59F29C29D11FDD97A5825A7482C33BDFE57C8CC164B267C891F20BC2C0BE78CE3FE06B0B27C0FA873A28272E941A76D75B9070BB36B333DDE678938AD3BEE98F5C4EE7AFDBFD645D15D65B2F36F1B0163C79A007C6F66E39353C0EE212B0B5B04EBDA4F1A27A7A5ED603C5CB77D309ABA8C7FB2B38A7DEC8D62E2E797F1A1BADDAE88BFD337F9E25800F0C0F2771F701D494C2C6EDA820F5B24EEA3B92362F691538FF768A6DB3D4C0E595B772034B37C4BE28311DDFAB503195DC147064BA353E643E5514754E3DAE6D1BC6F389237D89A51673B09EBBBE8CD1FAC28E68D8F618A42363C67CF37D86BAA935FE4F797E749457211AC4C0807BD6307EA363AABCD37AA758A8BBEA90E40653332AF89B5791215C14F036FA38ACACE0F1FAEEC5E39E7BBC6FBCDCF26DF7A7ADDE8EC6783B30A8ED536CFC36A58E80393F80060385E21D610721D52F5A15074A63305DADE08B95C7867386FEA94769AB5BA6DFFDB60F594C905CBBE46A504C88DF62AC75555B72C63F0A5E673B95EB065A34430D2247EAC30B1B25A7F9134F4536A14DEE4AD8781BE8B23D0565895D9A9DF9A49966D7132764F7E6F8730FF10A7FB99720FD6270229D2ACABA541FC58B0F2A770B32A0B66DF5226A4B9DC2EB64403FAB1BC2DC2325D85F5D88CBF121F7569D6F32CB6366366F32680C2FA51CECD668505CA8C50DB7473B89E5749435878A2DEE6516705B7FA81"
# }


# # 发送请求
# response = requests.post(url, headers=headers, data=data)

# # 检查响应状态
# if response.status_code == 200:
#     # 解密数据
#     decrypted_data = aes_decrypt( response.content,b'e82ckenh8dichen8')
    
#     # 保存到 response.json 文件
#     with open('response.json', 'w', encoding='utf-8') as json_file:
#         json.dump(json.loads(decrypted_data), json_file, ensure_ascii=False, indent=4)
#     print("解密后的数据已保存到 response.json 文件中。")
# else:
#     print(f"请求失败，状态码: {response.status_code}")